---
- name: Verify
  hosts: all
  become: yes
  tasks:
    - name: Check if Loki binary exists
      stat:
        path: /opt/loki/loki
      register: loki_binary

    - name: Assert Loki binary exists
      assert:
        that:
          - loki_binary.stat.exists
        fail_msg: "Loki binary not found"

    - name: Check if Loki service is running
      systemd:
        name: loki
      register: loki_service

    - name: Assert Loki service is running
      assert:
        that:
          - loki_service.status.ActiveState == "active"
        fail_msg: "Loki service is not running"

    - name: Check if Loki configuration file exists
      stat:
        path: /etc/loki/loki.yml
      register: loki_config

    - name: Assert Loki configuration exists
      assert:
        that:
          - loki_config.stat.exists
        fail_msg: "Loki configuration not found"

    - name: Check Loki API
      uri:
        url: http://localhost:3100/ready
        status_code: 200
      register: loki_health
      retries: 5
      delay: 3
      until: loki_health.status == 200
