---
- name: Check if PostgreSQL user exists
  shell: |
    sudo -u postgres psql -t -c "SELECT 1 FROM pg_roles WHERE rolname='{{ item.name }}'"
  loop: "{{ postgresql_users }}"
  loop_control:
    label: "{{ item.name }}"
  register: user_check
  when: postgresql_users is defined
  changed_when: false

- name: Create PostgreSQL user only if doesn't exist
  shell: |
    sudo -u postgres psql -c "CREATE USER {{ item.item.name }} WITH PASSWORD '{{ item.item.password }}' CREATEDB LOGIN;"
  loop: "{{ user_check.results }}"
  when: item.rc == 1  # User doesn't exist
  loop_control:
    label: "{{ item.item.name }}"

- name: Check if PostgreSQL database exists
  shell: |
    sudo -u postgres psql -t -c "SELECT 1 FROM pg_database WHERE datname='{{ item.name }}'"
  loop: "{{ postgresql_databases }}"
  loop_control:
    label: "{{ item.name }}"
  register: db_check
  when: postgresql_databases is defined
  changed_when: false

- name: Create PostgreSQL database only if doesn't exist
  shell: |
    sudo -u postgres createdb -O "{{ item.item.owner }}" -E "{{ item.item.encoding | default('UTF8') }}" "{{ item.item.name }}"
  loop: "{{ db_check.results }}"
  when: item.rc == 1  # Database doesn't exist
  loop_control:
    label: "{{ item.item.name }}"

- name: Ensure privileges are granted
  shell: |
    sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE {{ item.name }} TO {{ item.owner }};"
  loop: "{{ postgresql_databases }}"
  loop_control:
    label: "{{ item.name }}"
  when: postgresql_databases is defined

- name: Verify final database state
  shell: |
    sudo -u postgres psql -c "\l"
  register: final_db_list
  changed_when: false

- name: Display final database list
  debug:
    var: final_db_list.stdout
