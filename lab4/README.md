# Lab 4 - Развертывание OpenVPN сервера с помощью Ansible

## Описание

Эта лабораторная работа демонстрирует автоматизированное развертывание OpenVPN сервера с использованием Ansible. Включает полную настройку PKI (Public Key Infrastructure), генерацию сертификатов и создание клиентских конфигураций.

## Структура файлов

```
lab4/
├── inventory.ini         # Инвентарь хостов
├── openvpn_final.yml     # Полный плейбук развертывания OpenVPN
└── openvpn_role/         # Ansible роль для OpenVPN
    ├── main.yml          # Основные задачи роли
    ├── handlers/
    │   └── main.yml      # Обработчики событий
    └── templates/
        └── server.conf.j2 # Шаблон конфигурации сервера
```

## Описание файлов

### inventory.ini
Определяет целевой хост:
- `[openvpn_servers]` - группа серверов OpenVPN
- Использует Docker-соединение для тестирования

### openvpn_final.yml
Комплексный плейбук, выполняющий все этапы:

**1. Установка пакетов:**
- openvpn - VPN-сервер
- easy-rsa - инструменты PKI
- openssl - криптография

**2. Создание PKI инфраструктуры:**
- Инициализация PKI (`easyrsa init-pki`)
- Генерация CA сертификата (`easyrsa build-ca`)
- Создание серверного сертификата и ключа
- Генерация параметров Diffie-Hellman

**3. Настройка сервера:**
- Конфигурация VPN (порт 1194 UDP)
- Шифрование AES-256-CBC
- Сеть туннеля: 10.8.0.0/24
- Перенаправление трафика через VPN

**4. Генерация клиентских сертификатов:**
- Создание клиентского ключа и сертификата
- Генерация .ovpn файла со встроенными сертификатами

**5. Включение IP forwarding:**
- Настройка маршрутизации через sysctl

### openvpn_role/main.yml
Упрощенная роль для базовой установки:
- Установка пакетов OpenVPN
- Создание директории конфигурации
- Применение шаблона конфигурации
- Запуск systemd-сервиса

### openvpn_role/handlers/main.yml
Обработчик для перезапуска OpenVPN:
```yaml
- name: restart openvpn
  systemd:
    name: openvpn@server
    state: restarted
```

### openvpn_role/templates/server.conf.j2
Шаблон серверной конфигурации OpenVPN:
- **port 1194** - стандартный порт VPN
- **proto udp** - протокол (быстрее TCP)
- **dev tun** - туннельный интерфейс
- **server 10.8.0.0 255.255.255.0** - VPN-сеть
- **push** директивы - настройки для клиентов
- **cipher AES-256-CBC** - шифрование
- **keepalive 10 120** - проверка соединения

## Запуск

```bash
cd lab4

# Полное развертывание с генерацией сертификатов
ansible-playbook openvpn_final.yml

# Или использование роли (требует предварительной настройки PKI)
ansible-playbook -i inventory.ini openvpn_role/main.yml
```

## Результат

После выполнения:
- OpenVPN сервер запущен на порту 1194/UDP
- Сертификаты CA, сервера и клиента созданы
- Клиентский файл: `/etc/openvpn/client/client1.ovpn`
- Весь трафик клиентов перенаправляется через VPN

## Подключение клиента

```bash
# Скопируйте client1.ovpn на клиентскую машину
sudo openvpn --config client1.ovpn
```
